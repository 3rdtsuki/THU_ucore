### 基础知识

#### 计算机寄存器介绍

- 4个数据寄存器：eax,ebx,ecx,edx。它们的低16位寄存器命名为ax,bx,cx,dx
  - eax：累加器
  - ebx：基地址寄存器
  - ecx：计数寄存器
  - edx：数据寄存器
- 2个变址寄存器：esi,edi
- 2个指针寄存器：esp,ebp
- 6个段寄存器：
  - 代码段寄存器cs。结构：[代码段段号|TI|特权级]
  - 数据段寄存器ds
  - 堆栈段寄存器ss
  - 附加段寄存器es,fs,gs
- 指针指令寄存器eip
- 标志寄存器eflags

#### 内存堆栈

每个进程都被分配一块内存，地址从高到低为：

- 栈：存储函数的参数、返回值、局部变量，操作系统实时分配和释放
- 堆：程序员手动申请，动态分配内存
- bss区：未初始化全局变量
- 数据区：已初始化全局变量，静态变量，常量
- 代码区：可执行代码

#### 虚拟内存空间映射

32位地址可以表示4G的虚拟地址空间

可以看到大致从0到0xC0000000为用户空间，共3G。用户栈的栈底是0xB0000000，如果系统只支持单进程，自然整个用户空间都可以作为该进程的内存空间

从0xC0000000到4G是内核空间，共1G

memlayout.h

```c
/* *
 * Virtual memory map:                                          Permissions
 *                                                              kernel/user
 *
 *     4G ------------------> +---------------------------------+
 *                            |                                 |
 *                            |         Empty Memory (*)        |
 *                            |                                 |
 *                            +---------------------------------+ 0xFB000000
 *                            |   Cur. Page Table (Kern, RW)    | RW/-- PTSIZE
 *     VPT -----------------> +---------------------------------+ 0xFAC00000
 *                            |        Invalid Memory (*)       | --/--
 *     KERNTOP -------------> +---------------------------------+ 0xF8000000
 *                            |                                 |
 *                            |    Remapped Physical Memory     | RW/-- KMEMSIZE
 *                            |                                 |
 *     KERNBASE ------------> +---------------------------------+ 0xC0000000
 *                            |        Invalid Memory (*)       | --/--
 *     USERTOP -------------> +---------------------------------+ 0xB0000000
 *                            |           User stack            |
 *                            +---------------------------------+
 *                            |                                 |
 *                            :                                 :
 *                            |         ~~~~~~~~~~~~~~~~        |
 *                            :                                 :
 *                            |                                 |
 *                            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 *                            |       User Program & Heap       |
 *     UTEXT ---------------> +---------------------------------+ 0x00800000
 *                            |        Invalid Memory (*)       | --/--
 *                            |  - - - - - - - - - - - - - - -  |
 *                            |    User STAB Data (optional)    |
 *     USERBASE, USTAB------> +---------------------------------+ 0x00200000
 *                            |        Invalid Memory (*)       | --/--
 *     0 -------------------> +---------------------------------+ 0x00000000
 * (*) Note: The kernel ensures that "Invalid Memory" is *never* mapped.
 *     "Empty Memory" is normally unmapped, but user programs may map pages
 *     there if desired.
 *
 * */
```

